<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARGONIX MOVERS PVT. LTD. - Cloud Ledger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #002e5b; --accent: #f39c12; --success: #27ae60; --danger: #c0392b; --suraj: #8e44ad; --info: #2980b9; }
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; color: #333; }
        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; padding: 20px; }
        .login-box { background: white; color: #333; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .login-box input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
        .login-box button { width: 100%; padding: 15px; background: var(--accent); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; }
        .header-main { background: var(--primary); color: white; text-align: center; padding: 40px 20px 70px; border-bottom: 5px solid var(--accent); }
        .header-main h1 { margin: 0; font-size: 2.2rem; font-weight: 800; letter-spacing: 1px; }
        .stats-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin: -50px auto 30px; max-width: 1200px; padding: 0 20px; }
        .stat-box { background: white; flex: 1; min-width: 250px; padding: 20px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); text-align: center; border-top: 6px solid var(--accent); }
        .stat-val { font-size: 1.6rem; font-weight: 800; color: var(--primary); }
        .company-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; padding: 20px; max-width: 1400px; margin: auto; }
        .company-card { background: white; padding: 25px; border-radius: 18px; cursor: pointer; transition: 0.3s; border-left: 10px solid var(--primary); box-shadow: 0 6px 15px rgba(0,0,0,0.05); }
        .company-card:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); border-left-color: var(--accent); }
        .company-card h3 { margin: 0 0 10px 0; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1rem; height: 40px; overflow: hidden; }
        .comp-stats { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.85rem; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        #ledger-section { display: none; padding: 30px; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; background: white; padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 11px; font-weight: 700; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        .grid-form input { padding: 12px; border: 1.5px solid #eee; border-radius: 10px; font-family: 'Poppins'; }
        .auto-field { background: #f0f7ff !important; font-weight: bold; color: var(--primary); }
        .btn-action { grid-column: 1 / -1; display: flex; gap: 15px; }
        .btn-action button { flex: 1; padding: 16px; font-weight: 700; border:none; border-radius:12px; color:white; cursor:pointer; font-size: 1rem; }
        .search-container { margin-bottom: 15px; }
        .search-container input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1rem; box-sizing: border-box; outline: none; }
        .table-wrap { overflow-x: auto; background: white; border-radius: 20px; max-height: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 3000px; }
        th { background: var(--primary); color: white; padding: 18px 12px; font-size: 11px; text-align: left; position: sticky; top: 0; z-index: 10; }
        td { padding: 15px 12px; border-bottom: 1px solid #f0f0f0; font-size: 12px; white-space: nowrap; }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; }
        .badge-profit { background: #e8f5e9; color: #2e7d32; }
        .badge-pending { background: #ffebee; color: #c62828; }
        .btn-del { background: #e74c3c; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; }
        .btn-edit { background: #3498db; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; margin-right: 5px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:var(--primary)">Cargonix Cloud</h2>
        <input type="text" id="userPhone" placeholder="Mobile Number" maxlength="10">
        <input type="password" id="userPin" placeholder="4-Digit PIN" maxlength="4">
        <button onclick="cloudLogin()">LOGIN & LOAD DATA</button>
    </div>
</div>

<div id="landing-page" style="display:none">
    <div class="header-main"><h1>CARGONIX MOVERS PVT. LTD.</h1></div>
    <div class="stats-container">
        <div class="stat-box"><h4>Total Profit (With GST)</h4><div class="stat-val" id="gTotal">‚Çπ 0</div></div>
        <div class="stat-box" style="border-top-color: var(--success);"><h4>Without GST Profit</h4><div class="stat-val" id="gTotalNoGst" style="color:var(--success)">‚Çπ 0</div></div>
        <div class="stat-box" style="border-top-color: var(--danger);"><h4>Total Party Pending</h4><div class="stat-val" id="gPend" style="color:var(--danger)">‚Çπ 0</div></div>
    </div>
    <div class="company-grid" id="compGrid"></div>
</div>

<div id="ledger-section">
    <div class="nav-bar">
        <button onclick="goBack()" style="background:#555; color:white; border:none; padding:12px 25px; border-radius:10px; cursor:pointer;">‚¨Ö Dashboard</button>
        <h2 id="viewTitle" style="color:var(--primary); margin:0;">Company Name</h2>
        <button onclick="exportExcel()" style="background:#1d6f42; color:white; border:none; padding:12px 25px; border-radius:10px; cursor:pointer;">üìä Export Excel</button>
    </div>

    <div class="grid-form" id="standardForm">
        <input type="hidden" id="editIndex" value="-1">
        <div class="input-group"><label>Date</label><input type="date" id="fDate"></div>
        <div class="input-group"><label>Bilty No</label><input type="text" id="fBilty"></div>
        <div class="input-group"><label>Bill No</label><input type="text" id="fBill"></div>
        <div class="input-group"><label>From</label><input type="text" id="fFrom"></div>
        <div class="input-group"><label>To</label><input type="text" id="fTo"></div>
        <div class="input-group"><label>Party Charge</label><input type="number" id="fPartyCharge" oninput="stdCalc()"></div>
        <div class="input-group"><label>GST (18%)</label><input type="number" id="fGST" class="auto-field" readonly></div>
        <div class="input-group"><label>Total Bill</label><input type="number" id="fTotalBill" class="auto-field" readonly></div>
        <div class="input-group"><label>Party Pending</label><input type="number" id="fPartyPending"></div>
        <div class="input-group"><label>Truck Hire</label><input type="number" id="fTruckHire" oninput="stdCalc()"></div>
        <div class="input-group"><label>Porter & Loading</label><input type="number" id="fLoading" oninput="stdCalc()"></div>
        <div class="input-group"><label>Truck Total</label><input type="number" id="fTruckTotal" class="auto-field" readonly></div>
        <div class="input-group"><label>Broker Name</label><input type="text" id="fBrokerName"></div>
        <div class="input-group"><label>Adv</label><input type="number" id="fAdv" oninput="stdCalc()"></div>
        <div class="input-group"><label>Brok Pending</label><input type="number" id="fPending" class="auto-field" readonly></div>
        <div class="input-group"><label>Clear Date</label><input type="date" id="fClearDate"></div>
        <div class="input-group"><label>Weight</label><input type="text" id="fWeight"></div>
        <div class="input-group"><label>Box</label><input type="number" id="fBox"></div>
        <div class="input-group"><label>Vehicle</label><input type="text" id="fVehicle"></div>
        <div class="input-group" style="display:none;"><label>Profit</label><input type="number" id="fProfit" class="auto-field" readonly></div>
        <div class="btn-action">
            <button id="saveBtn" onclick="saveEntry()" style="background:var(--success);">SAVE RECORD</button>
            <button id="cancelBtn" onclick="clearForm()" style="background:#888; display:none;">CANCEL</button>
        </div>
    </div>

    <div class="grid-form" id="surajForm" style="display:none;">
        <input type="hidden" id="sEditIndex" value="-1">
        <div class="input-group"><label>Date</label><input type="date" id="sDate"></div>
        <div class="input-group"><label>Bilty No</label><input type="text" id="sBilty"></div>
        <div class="input-group"><label>From</label><input type="text" id="sFrom"></div>
        <div class="input-group"><label>To</label><input type="text" id="sTo"></div>
        <div class="input-group"><label>Party Name</label><input type="text" id="sPName"></div>
        <div class="input-group"><label>Party Charge</label><input type="number" id="sCharge" oninput="surajCalc()"></div>
        <div class="input-group"><label>GST (18%)</label><input type="number" id="sGST" class="auto-field" readonly></div>
        <div class="input-group"><label>Total Bill</label><input type="number" id="sTotalBill" class="auto-field" readonly></div>
        <div class="input-group"><label>Party Pending</label><input type="number" id="sPPend"></div>
        <div class="input-group"><label>Truck Hire</label><input type="number" id="sHire" oninput="surajCalc()"></div>
        <div class="input-group"><label>Toll</label><input type="number" id="sToll" oninput="surajCalc()"></div>
        <div class="input-group"><label>Diesel</label><input type="number" id="sDiesel" oninput="surajCalc()"></div>
        <div class="input-group"><label>KM</label><input type="number" id="sKM"></div>
        <div class="input-group"><label>Broker Adv</label><input type="number" id="sBAdv" oninput="surajCalc()"></div>
        <div class="input-group"><label>Broker Pend</label><input type="number" id="sBPend" class="auto-field" readonly></div>
        <div class="input-group"><label>Weight</label><input type="text" id="sWeight"></div>
        <div class="input-group"><label>Box</label><input type="number" id="sBox"></div>
        <div class="input-group"><label>Vehicle</label><input type="text" id="sVehicle"></div>
        <div class="input-group" style="display:none;"><label>Profit</label><input type="number" id="sProfit" class="auto-field" readonly></div>
        <div class="btn-action">
            <button id="sSaveBtn" onclick="saveSuraj()" style="background:var(--suraj);">SAVE SURAJ RECORD</button>
            <button id="sCancelBtn" onclick="clearForm()" style="background:#888; display:none;">CANCEL</button>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="üîç Search by Bilty No, Vehicle, Bill No, Broker or Route...">
    </div>

    <div class="table-wrap">
        <table id="mainTable">
            <thead id="tHead"></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<script>
    let activeID = '';
    let currentUserKey = '';
    // Companies list updated: Suraj Yadev moved to top, Avinya added.
    const companies = [
        {id:'C6', name:'SURAJ YADEV (W.B)'},
        {id:'C1', name:'AKASA CLEAN ENERGY PRIVATE LIMITED'}, 
        {id:'C2', name:'CLN ENERGY LIMITED'},
        {id:'C3', name:'MEFRON TECHNOLOGIES INDIA PVT LTD'}, 
        {id:'C4', name:'ABILITY AUTOMATION SOLUTIONS PVT LTD'},
        {id:'C5', name:'PREMIER PAPER PACKAGING PVT LTD'},
        {id:'C7', name:'AVINYA BATTERIES LIMITED'}
    ];
    let db = {C1:[], C2:[], C3:[], C4:[], C5:[], C6:[], C7:[]};

    const formatINR = (amt) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(amt);
    const formatDate = (d) => d ? d.split("-").reverse().join("-") : "-";

    function cloudLogin() {
        const phone = document.getElementById('userPhone').value;
        if(phone.length < 10) return alert("Phone number sahi se dalein!");
        currentUserKey = "cargonix_v12_" + phone;
        let saved = localStorage.getItem(currentUserKey);
        if(saved) db = JSON.parse(saved);
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('landing-page').style.display = 'block';
        init();
    }

    function init() {
        const grid = document.getElementById('compGrid');
        grid.innerHTML = '';
        companies.forEach(c => {
            let p = 0, n = 0, bAdv = 0, bPend = 0, gstTotal = 0;
            if(db[c.id]) {
                db[c.id].forEach(r => { 
                    p += parseFloat(r.profit) || 0; 
                    n += parseFloat(r.fPartyPending || r.pPend || 0);
                    bAdv += parseFloat(r.adv || r.bAdv || 0);
                    bPend += parseFloat(r.bPend || 0);
                    gstTotal += parseFloat(r.gst || 0);
                });
            }
            let profitNoGst = p - gstTotal;

            grid.innerHTML += `<div class="company-card" onclick="openLedger('${c.id}', '${c.name}')">
                <h3>${c.name}</h3>
                <div class="comp-stats">
                    <div class="stat-row"><span>Profit (With GST):</span> <b style="color:var(--success)">${formatINR(p)}</b></div>
                    <div class="stat-row"><span>Without GST Profit:</span> <b style="color:var(--info)">${formatINR(profitNoGst)}</b></div>
                    <div class="stat-row"><span>Party Pend:</span> <b style="color:var(--danger)">${formatINR(n)}</b></div>
                    <div class="stat-row"><span>Brok Adv:</span> <b style="color:#2980b9">${formatINR(bAdv)}</b></div>
                    <div class="stat-row"><span>Brok Pend:</span> <b style="color:#e67e22">${formatINR(bPend)}</b></div>
                </div>
            </div>`;
        });
        updateStats();
    }

    function stdCalc() {
        let charge = parseFloat(document.getElementById('fPartyCharge').value) || 0;
        let hire = parseFloat(document.getElementById('fTruckHire').value) || 0;
        let loading = parseFloat(document.getElementById('fLoading').value) || 0;
        let adv = parseFloat(document.getElementById('fAdv').value) || 0;
        document.getElementById('fGST').value = (charge * 0.18).toFixed(0);
        document.getElementById('fTotalBill').value = (charge * 1.18).toFixed(0);
        document.getElementById('fTruckTotal').value = (hire + loading).toFixed(0);
        document.getElementById('fPending').value = (hire + loading - adv).toFixed(0);
        // Profit with GST logic
        document.getElementById('fProfit').value = ((charge * 1.18) - (hire + loading)).toFixed(0);
    }

    function surajCalc() {
        let charge = parseFloat(document.getElementById('sCharge').value) || 0;
        let hire = parseFloat(document.getElementById('sHire').value) || 0;
        let bAdv = parseFloat(document.getElementById('sBAdv').value) || 0;
        document.getElementById('sGST').value = (charge * 0.18).toFixed(0);
        document.getElementById('sTotalBill').value = (charge * 1.18).toFixed(0);
        document.getElementById('sBPend').value = (hire - bAdv).toFixed(0);
        document.getElementById('sProfit').value = ((charge * 1.18) - hire).toFixed(0);
    }

    function openLedger(id, name) {
        activeID = id;
        document.getElementById('landing-page').style.display = 'none';
        document.getElementById('ledger-section').style.display = 'block';
        document.getElementById('viewTitle').innerText = name;
        document.getElementById('surajForm').style.display = (id === 'C6') ? 'grid' : 'none';
        document.getElementById('standardForm').style.display = (id === 'C6') ? 'none' : 'grid';
        clearForm();
        renderTable();
    }

    function saveEntry() {
        const idx = parseInt(document.getElementById('editIndex').value);
        const row = {
            date: document.getElementById('fDate').value, 
            bilty: document.getElementById('fBilty').value,
            bill: document.getElementById('fBill').value, 
            from: document.getElementById('fFrom').value,
            to: document.getElementById('fTo').value, 
            charge: document.getElementById('fPartyCharge').value,
            gst: document.getElementById('fGST').value, 
            totalBill: document.getElementById('fTotalBill').value,
            fPartyPending: document.getElementById('fPartyPending').value, 
            hire: document.getElementById('fTruckHire').value,
            loading: document.getElementById('fLoading').value, 
            truckTotal: document.getElementById('fTruckTotal').value,
            brokerName: document.getElementById('fBrokerName').value,
            adv: document.getElementById('fAdv').value, 
            bPend: document.getElementById('fPending').value,
            clearDate: document.getElementById('fClearDate').value, 
            weight: document.getElementById('fWeight').value,
            box: document.getElementById('fBox').value, 
            veh: document.getElementById('fVehicle').value, 
            profit: document.getElementById('fProfit').value
        };
        if(idx === -1) db[activeID].push(row); else db[activeID][idx] = row;
        db[activeID].sort((a,b) => new Date(a.date) - new Date(b.date));
        finishSave();
    }

    function saveSuraj() {
        const idx = parseInt(document.getElementById('sEditIndex').value);
        const row = {
            date: document.getElementById('sDate').value, 
            bilty: document.getElementById('sBilty').value,
            from: document.getElementById('sFrom').value, 
            to: document.getElementById('sTo').value,
            pName: document.getElementById('sPName').value, 
            charge: document.getElementById('sCharge').value,
            gst: document.getElementById('sGST').value, 
            totalBill: document.getElementById('sTotalBill').value,
            pPend: document.getElementById('sPPend').value, 
            hire: document.getElementById('sHire').value,
            toll: document.getElementById('sToll').value, 
            diesel: document.getElementById('sDiesel').value,
            km: document.getElementById('sKM').value, 
            bAdv: document.getElementById('sBAdv').value,
            bPend: document.getElementById('sBPend').value, 
            weight: document.getElementById('sWeight').value,
            box: document.getElementById('sBox').value, 
            veh: document.getElementById('sVehicle').value,
            profit: document.getElementById('sProfit').value
        };
        if(idx === -1) db.C6.push(row); else db.C6[idx] = row;
        db.C6.sort((a,b) => new Date(a.date) - new Date(b.date));
        finishSave();
    }

    function finishSave() {
        localStorage.setItem(currentUserKey, JSON.stringify(db));
        alert("‚úÖ Record Saved!");
        clearForm();
        renderTable();
        updateStats();
    }

    function renderTable() {
        const head = document.getElementById('tHead');
        const body = document.getElementById('tBody');
        body.innerHTML = '';
        if(!db[activeID]) return;

        if(activeID === 'C6') {
            head.innerHTML = `<tr><th>Date</th><th>Bilty No</th><th>From</th><th>To</th><th>Party Name</th><th>Charge</th><th>GST</th><th>Total Bill</th><th>P.Pend</th><th>Hire</th><th>Toll</th><th>Diesel</th><th>KM</th><th>B.Adv</th><th>B.Pend</th><th>Weight</th><th>Box</th><th>Vehicle</th><th>Profit</th><th>Actions</th></tr>`;
            db.C6.forEach((r, idx) => {
                body.innerHTML += `<tr><td>${formatDate(r.date)}</td><td>${r.bilty}</td><td>${r.from}</td><td>${r.to}</td><td>${r.pName}</td><td>${r.charge}</td><td>${r.gst}</td><td>${r.totalBill}</td><td class="badge-pending">${r.pPend}</td><td>${r.hire}</td><td>${r.toll}</td><td>${r.diesel}</td><td>${r.km}</td><td>${r.bAdv}</td><td class="badge-pending">${r.bPend}</td><td>${r.weight}</td><td>${r.box}</td><td>${r.veh}</td><td class="badge-profit">${r.profit}</td><td><button class="btn-edit" onclick="editSuraj(${idx})">‚úèÔ∏è</button><button class="btn-del" onclick="delR(${idx})">üóëÔ∏è</button></td></tr>`;
            });
        } else {
            head.innerHTML = `<tr><th>Date</th><th>Bilty No</th><th>Bill No</th><th>From</th><th>To</th><th>Party Charge</th><th>GST</th><th>Total Bill</th><th>P.Pend</th><th>Hire</th><th>Porter & Loading</th><th>Truck Total</th><th>Broker Name</th><th>Adv</th><th>Brok Pend</th><th>Clear Date</th><th>Weight</th><th>Box</th><th>Vehicle</th><th>Profit</th><th>Actions</th></tr>`;
            db[activeID].forEach((r, idx) => {
                body.innerHTML += `<tr><td>${formatDate(r.date)}</td><td>${r.bilty}</td><td>${r.bill}</td><td>${r.from}</td><td>${r.to}</td><td>${r.charge}</td><td>${r.gst}</td><td>${r.totalBill}</td><td class="badge-pending">${r.fPartyPending}</td><td>${r.hire}</td><td>${r.loading}</td><td>${r.truckTotal}</td><td>${r.brokerName || '-'}</td><td>${r.adv}</td><td class="badge-pending">${r.bPend}</td><td>${formatDate(r.clearDate)}</td><td>${r.weight}</td><td>${r.box}</td><td>${r.veh}</td><td class="badge-profit">${r.profit}</td><td><button class="btn-edit" onclick="editStd(${idx})">‚úèÔ∏è</button><button class="btn-del" onclick="delR(${idx})">üóëÔ∏è</button></td></tr>`;
            });
        }
    }

    function editStd(idx) {
        const r = db[activeID][idx];
        document.getElementById('editIndex').value = idx;
        document.getElementById('fDate').value = r.date;
        document.getElementById('fBilty').value = r.bilty;
        document.getElementById('fBill').value = r.bill;
        document.getElementById('fFrom').value = r.from;
        document.getElementById('fTo').value = r.to;
        document.getElementById('fPartyCharge').value = r.charge;
        document.getElementById('fPartyPending').value = r.fPartyPending;
        document.getElementById('fTruckHire').value = r.hire;
        document.getElementById('fLoading').value = r.loading;
        document.getElementById('fBrokerName').value = r.brokerName || '';
        document.getElementById('fAdv').value = r.adv;
        document.getElementById('fClearDate').value = r.clearDate;
        document.getElementById('fWeight').value = r.weight;
        document.getElementById('fBox').value = r.box;
        document.getElementById('fVehicle').value = r.veh;
        stdCalc();
        document.getElementById('saveBtn').innerText = "UPDATE RECORD";
        document.getElementById('cancelBtn').style.display = "block";
    }

    function editSuraj(idx) {
        const r = db.C6[idx];
        document.getElementById('sEditIndex').value = idx;
        document.getElementById('sDate').value = r.date;
        document.getElementById('sBilty').value = r.bilty;
        document.getElementById('sFrom').value = r.from;
        document.getElementById('sTo').value = r.to;
        document.getElementById('sPName').value = r.pName;
        document.getElementById('sCharge').value = r.charge;
        document.getElementById('sPPend').value = r.pPend;
        document.getElementById('sHire').value = r.hire;
        document.getElementById('sToll').value = r.toll;
        document.getElementById('sDiesel').value = r.diesel;
        document.getElementById('sKM').value = r.km;
        document.getElementById('sBAdv').value = r.bAdv;
        document.getElementById('sWeight').value = r.weight;
        document.getElementById('sBox').value = r.box;
        document.getElementById('sVehicle').value = r.veh;
        surajCalc();
        document.getElementById('sSaveBtn').innerText = "UPDATE SURAJ";
        document.getElementById('sCancelBtn').style.display = "block";
    }

    function searchTable() {
        let input = document.getElementById('searchInput').value.toUpperCase();
        let tr = document.getElementById('mainTable').getElementsByTagName('tr');
        for (let i = 1; i < tr.length; i++) {
            let found = false, td = tr[i].getElementsByTagName('td');
            for (let j = 0; j < td.length - 1; j++) {
                if (td[j] && td[j].innerHTML.toUpperCase().indexOf(input) > -1) found = true;
            }
            tr[i].style.display = found ? "" : "none";
        }
    }

    function delR(idx) { if(confirm("Delete?")) { db[activeID].splice(idx, 1); finishSave(); } }

    function clearForm() {
        document.querySelectorAll('input').forEach(i => { if(i.type !== 'hidden') i.value = '' });
        document.getElementById('editIndex').value = "-1";
        document.getElementById('sEditIndex').value = "-1";
        document.getElementById('saveBtn').innerText = "SAVE RECORD";
        document.getElementById('sSaveBtn').innerText = "SAVE SURAJ RECORD";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('sCancelBtn').style.display = "none";
    }

    function updateStats() {
        let tp = 0, tn = 0, tgst = 0;
        companies.forEach(c => {
            if(db[c.id]) {
                db[c.id].forEach(r => { 
                    tp += parseFloat(r.profit) || 0; 
                    tn += parseFloat(r.fPartyPending || r.pPend || 0); 
                    tgst += parseFloat(r.gst || 0);
                });
            }
        });
        document.getElementById('gTotal').innerText = formatINR(tp);
        document.getElementById('gTotalNoGst').innerText = formatINR(tp - tgst);
        document.getElementById('gPend').innerText = formatINR(tn);
    }

    function goBack() { document.getElementById('landing-page').style.display = 'block'; document.getElementById('ledger-section').style.display = 'none'; init(); }
    
    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(db[activeID]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ledger");
        XLSX.writeFile(wb, `${activeID}_Report.xlsx`);
    }
</script>
</body>
</html>
